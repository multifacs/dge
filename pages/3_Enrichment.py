import streamlit as st
import pandas as pd



st.title("Gene Enrichment Analysis")

# Check if group datasets exist in session state
# if 'group_datasets' not in st.session_state or not st.session_state.group_datasets:
#     st.warning("Please load and prepare datasets on the Load Data page first!")
#     st.stop()

from enrichr_analyzer import EnrichrAnalyzer

# –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
gene_input = st.text_area("Enter gene symbols (one per line)", "BRCA1\nTP53\nEGFR\nMYC\nCDKN2A")
gene_list = [g.strip() for g in gene_input.split('\n') if g.strip()]

description = st.text_input("Analysis description")
library = st.selectbox("Select library", ["KEGG_2016", "GO_Biological_Process_2021"])

if len(gene_input) and st.button("Run Analysis"):
    analyzer = EnrichrAnalyzer()
    
    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    with st.spinner("Running enrichment analysis..."):
        results = analyzer.enrich(gene_list, description, library)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    st.subheader("Enrichment Results")
    st.dataframe(results)
    
    st.markdown("""
    ### **–ö–∞–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Ç—å –æ–±–æ–≥–∞—â–µ–Ω–∏—è –∏ —á—Ç–æ –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç?**  

    –°–µ—Ç—å –æ–±–æ–≥–∞—â–µ–Ω–∏—è (Enrichment Network) ‚Äî —ç—Ç–æ –≥—Ä–∞—Ñ, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É **–≥–µ–Ω–∞–º–∏** –∏ **–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É—Ç—è–º–∏ KEGG –∏–ª–∏ GO-—Ç–µ—Ä–º–∏–Ω–∞–º–∏), –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∞–Ω–∞–ª–∏–∑–∞ –æ–±–æ–≥–∞—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Enrichr).  

    ---

    ## **1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏**
    –ì—Ä–∞—Ñ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ **–¥–≤—É—Ö —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤** –∏ **—Ä–µ–±–µ—Ä** –º–µ–∂–¥—É –Ω–∏–º–∏:  

    ### **üîµ –£–∑–ª—ã (Nodes)**
    - **üî∂ –¢–µ—Ä–º–∏–Ω—ã (–ö–≤–∞–¥—Ä–∞—Ç—ã)**  
    - –≠—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–æ–≥–∞—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Bladder cancer", "MicroRNAs in cancer").  
    - **–¶–≤–µ—Ç** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞—á–∏–º–æ—Å—Ç—å: —á–µ–º **–∫—Ä–∞—Å–Ω–µ–µ**, —Ç–µ–º **–º–µ–Ω—å—à–µ p-value** (–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã–π —Ç–µ—Ä–º–∏–Ω).  
    - **–†–∞–∑–º–µ—Ä** –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–∂–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥–µ–Ω–æ–≤ –∏–ª–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–ª (Combined Score).  

    - **üîµ –ì–µ–Ω—ã (–ö—Ä—É–≥–∏)**  
    - –≠—Ç–æ –≥–µ–Ω—ã –∏–∑ –≤–∞—à–µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–ª–∏ –≤ –¥–∞–Ω–Ω—ã–π —Ç–µ—Ä–º–∏–Ω.  
    - –û–±—ã—á–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è **—Å–∏–Ω–∏–º** —Ü–≤–µ—Ç–æ–º.  

    ### **üîó –†–µ–±—Ä–∞ (Edges)**  
    - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç, **–∫–∞–∫–∏–µ –≥–µ–Ω—ã –≤—Ö–æ–¥—è—Ç –≤ –∫–∞–∫–æ–π —Ç–µ—Ä–º–∏–Ω**.  
    - –ï—Å–ª–∏ –≥–µ–Ω —Å–≤—è–∑–∞–Ω —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏, —ç—Ç–æ –≤–∏–¥–Ω–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.  

    ---

    ## **2. –ö–∞–∫ —Å—Ç—Ä–æ–∏—Ç—Å—è –≥—Ä–∞—Ñ?**  
    1. **–ò–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Enrichr –±–µ—Ä—É—Ç—Å—è —Ç–æ–ø–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 20 —Å–∞–º—ã—Ö –∑–Ω–∞—á–∏–º—ã—Ö).  
    2. **–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –≥–µ–Ω—ã**, –∫–æ—Ç–æ—Ä—ã–µ –≤ –Ω–µ–≥–æ –≤—Ö–æ–¥—è—Ç.  
    3. **–°–æ–∑–¥–∞–µ—Ç—Å—è –≥—Ä–∞—Ñ** (`networkx.Graph`), –≥–¥–µ:  
    - **–¢–µ—Ä–º–∏–Ω—ã ‚Üí –∫–≤–∞–¥—Ä–∞—Ç—ã**  
    - **–ì–µ–Ω—ã ‚Üí –∫—Ä—É–≥–∏**  
    - **–†–µ–±—Ä–∞ ‚Üí —Å–≤—è–∑–∏ "—Ç–µ—Ä–º–∏–Ω-–≥–µ–Ω"**  
    4. **–†–∞—Å–∫—Ä–∞—Å–∫–∞ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**  
    - –¢–µ—Ä–º–∏–Ω—ã —Ä–∞—Å–∫—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –ø–æ **p-value** (–∫—Ä–∞—Å–Ω—ã–π = –∑–Ω–∞—á–∏–º—ã–π).  
    - –ì–µ–Ω—ã –≤—Å–µ–≥–¥–∞ **—Å–∏–Ω–∏–µ**.  
    - –ü–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º (`spring_layout`), —á—Ç–æ–±—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—ã–ª–∏ –±–ª–∏–∂–µ.  

    ---

    ## **3. –ß—Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤ —Ç–∞–∫–æ–º –≥—Ä–∞—Ñ–µ?**  
    ‚úÖ **–ö–∞–∫–∏–µ –≥–µ–Ω—ã –≤—Ö–æ–¥—è—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É—Ç–µ–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, TP53 –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ –≤ —Ä–∞–∫–µ, –∏ –≤ –∞–ø–æ–ø—Ç–æ–∑–µ).  
    ‚úÖ **–ö–∞–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã —Å–∞–º—ã–µ –∑–Ω–∞—á–∏–º—ã–µ** (—á–µ–º –∫—Ä–∞—Å–Ω–µ–µ, —Ç–µ–º –≤–∞–∂–Ω–µ–µ).  
    ‚úÖ **–ï—Å—Ç—å –ª–∏ –∫–ª–∞—Å—Ç–µ—Ä—ã** (–≥—Ä—É–ø–ø—ã —Ç–µ—Ä–º–∏–Ω–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –æ–±—â–∏–µ –≥–µ–Ω—ã).  

    ---

    ## **4. –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏**  
    –î–æ–ø—É—Å—Ç–∏–º, —É –≤–∞—Å –µ—Å—Ç—å –≥—Ä–∞—Ñ, –≥–¥–µ:  
    - **–¢–µ—Ä–º–∏–Ω "Bladder cancer"** (–∫—Ä–∞—Å–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç) —Å–≤—è–∑–∞–Ω —Å –≥–µ–Ω–∞–º–∏ **TP53, EGFR**.  
    - **–¢–µ—Ä–º–∏–Ω "MicroRNAs in cancer"** (–æ—Ä–∞–Ω–∂–µ–≤—ã–π –∫–≤–∞–¥—Ä–∞—Ç) —Å–≤—è–∑–∞–Ω —Å **TP53, MYC**.  

    **–í—ã–≤–æ–¥:**  
    - **TP53** —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –æ–±–æ–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ, –∫–ª—é—á–µ–≤–æ–π –≥–µ–Ω.  
    - **"Bladder cancer"** –±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º (–∫—Ä–∞—Å–Ω–µ–µ), —á–µ–º **"MicroRNAs in cancer"**.  

    ---

    ### **–ò—Ç–æ–≥**  
    –°–µ—Ç—å –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ø–æ–º–æ–≥–∞–µ—Ç **–≤–∏–∑—É–∞–ª—å–Ω–æ** –æ—Ü–µ–Ω–∏—Ç—å:  
    1. **–ö–∞–∫–∏–µ –≥–µ–Ω—ã –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã** (–º–Ω–æ–≥–æ —Å–≤—è–∑–µ–π).  
    2. **–ö–∞–∫–∏–µ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã/–ø—É—Ç–∏ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã** (—Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä —É–∑–ª–æ–≤).  
    3. **–ï—Å—Ç—å –ª–∏ –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** (–∫–ª–∞—Å—Ç–µ—Ä—ã —Ç–µ—Ä–º–∏–Ω–æ–≤).  

    –≠—Ç–æ –≥–æ—Ä–∞–∑–¥–æ —É–¥–æ–±–Ω–µ–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å p-value! üöÄ
    """)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç—å
    st.subheader("Enrichment Network")
    analyzer.plot_enrichment_network(results)
